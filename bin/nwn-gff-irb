#!/usr/bin/ruby
require 'rubygems'
require 'optparse'
require 'nwn/all'
require 'irb'
require 'irb/completion'

OptionParser.new do |o|
  o.banner = "Usage: nwn-gff-irb file"
end.parse!

file = ARGV.shift or begin
  $stderr.puts "Required argument: filename to process, or - for stdin (try -h)."
  exit 1
end

if file == "-"
  bytes = $stdin.read
else
  bytes = IO.read(file)
end
$file = File.expand_path(file)

if File.extname($file) == ".yml"
  GFF = YAML.load(bytes)
else
  GFF = NWN::Gff::Reader.read(bytes)
end

def save destination = nil
  destination ||= $file
  puts "Saving to Â´#{destination}' .."
  if File.extname($file) == ".yml"
    bytes = GFF.to_yaml
  else
    bytes = NWN::Gff::Writer.dump(GFF)
  end
  File.open(destination, "w") {|f|
    f.write(bytes)
  }
  puts "saved."
end

include NWN::Gff
include NWN::TwoDA

puts "Your GFF file is in `GFF' (type: #{GFF.data_type.inspect})."
puts "Type `save' to save to the filename it came from (make a backup!), `exit' (or Ctrl+D) to exit (without saving)."
puts "To save to a different location, type `save \"path/to/new/location.ext\"'."
puts ""

IRB.start
