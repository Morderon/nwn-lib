#!/usr/bin/ruby
require 'rubygems'
require 'optparse'
require 'nwn/gff'
require 'yaml'

format = nil
types_too = false

OptionParser.new do |o|
  o.banner = "Usage: nwn-gff-print [options] file/- [path]"
  o.on "-y", "--yaml", "Dump as yaml" do
    format = :yaml
  end
  o.on "-k", "--kivinen", "Dump as kivinens dump format (like the perl tools)" do
    format = :kivinen
  end
  o.on "-t", "--types", "Dump types as well (only applies to -k, for now)" do
    types_too = true
  end
end.parse!

file = ARGV.shift or begin
  $stderr.puts "Required argument: filename to process, or - for stdin (try -h)."
  exit 1
end

path = ARGV.shift

if file == "-"
  bytes = $stdin.read
else
  bytes = IO.read(file)
end

g = NWN::Gff::Reader.read(bytes)

if path
  begin
    g = g[path]
  rescue Exception => e
    $stderr.puts "Error: " + e.to_s
    exit 1
  end
end

case format
  when :yaml
    y g
  when :kivinen
    NWN::Gff.kivinen_format g, "/", types_too do |label, value|
      puts "%s:\t%s" % [label, value]
    end
  else
    puts "Unknown format; try -h"
end
